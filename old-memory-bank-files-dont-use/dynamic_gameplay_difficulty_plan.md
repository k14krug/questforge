# Plan: Dynamic Gameplay Difficulty

## Feature Title
Dynamic Gameplay Difficulty

## Objective
Implement functionality to allow the game creator to adjust the difficulty level of a game *during* active gameplay. This dynamic difficulty will primarily influence the main AI narrative responses, particularly how the AI handles player actions that may seem unreasonable or impossible within the game context.

## Difficulty Levels
The supported difficulty levels will be:
*   Easy
*   Normal
*   Hard

## Impact
The dynamic difficulty setting will primarily affect the AI's narrative response generated by `ai_service.get_response`. It will *not* directly affect the logic for determining plot point completion (`ai_service.check_atomic_plot_completion`) or other core game mechanics unless explicitly decided later.

The specific impact on the main AI narrative for unreasonable or impossible player actions will follow this logic:
*   **Easy:** The AI should be lenient, potentially allowing the action or providing a surprisingly positive outcome, even if it seems unreasonable.
*   **Normal:** The AI should explain why the action cannot be done based on the current game setting, context, or surrounding environment.
*   **Hard:** The AI should narrate that the action fails and introduce a negative consequence or setback related to the attempt.

## Implementation Steps

1.  **Database Model Modification:**
    *   Modify the `Game` model in `questforge/models/game.py`.
    *   Add a new column `current_difficulty` of type `db.String(20)`, with a `default='Normal'` and `nullable=False`.
    *   Ensure this field is initialized when a new `Game` record is created, using the difficulty selected during game creation (from `template_overrides` or the template's default).

2.  **Database Migration:**
    *   Generate a new migration script using Flask-Migrate: `flask db migrate -m "Add current_difficulty to Game model"`.
    *   Review the generated script.
    *   Apply the migration: `flask db upgrade`.

3.  **UI Implementation (`play.html` and `socketClient.mjs`):**
    *   Add a UI element (e.g., dropdown, radio buttons, or segmented control) on the `questforge/templates/game/play.html` page to display the current difficulty and allow the game creator to select a new one from 'Easy', 'Normal', 'Hard'.
    *   Implement JavaScript in `questforge/static/js/socketClient.mjs`:
        *   Add logic to receive the initial `current_difficulty` value when the `game_state` is received (via the `request_state` handler).
        *   Update the UI element to display the received difficulty.
        *   Add an event listener to the UI element to detect changes.
        *   When the difficulty is changed by the user, emit a new SocketIO event (e.g., `change_difficulty`) to the server, including the `game_id`, the current `user_id`, and the `new_difficulty` value.

4.  **Backend SocketIO Handler (`socket_service.py`):**
    *   Create a new SocketIO event handler `@socketio.on('change_difficulty')` in `questforge/services/socket_service.py`.
    *   Inside this handler:
        *   Retrieve the `game_id`, `user_id`, and `new_difficulty` from the received data.
        *   Validate that the user (`user_id`) is the creator of the game (`game_id`).
        *   Validate that the `new_difficulty` value is one of the allowed levels ('easy', 'Normal', 'hard').
        *   Fetch the `Game` record from the database using `game_id`.
        *   Update the `game.current_difficulty` field with the `new_difficulty`.
        *   Commit the database session (`db.session.commit()`).
        *   Emit a SocketIO event (e.g., `difficulty_changed`) to all players in the game room (`game_id`), providing the `new_difficulty` value. This allows client UIs to update and potentially display a system message in the game log (handled client-side).

5.  **Integrate Difficulty into Main AI Narrative:**
    *   **Modify `socket_service.py` (`handle_player_action`):**
        *   When fetching the `GameState` and `Campaign`, ensure the associated `Game` object is also fetched (e.g., using `joinedload`).
        *   Retrieve the `game.current_difficulty`.
        *   Pass this `current_difficulty` value as a new argument when calling `ai_service.get_response`.
    *   **Modify `ai_service.py` (`get_response`):**
        *   Update the signature of the `get_response` method to accept the `current_difficulty` string.
        *   Pass this `current_difficulty` value as a new argument when calling `prompt_builder.build_response_prompt`.
    *   **Modify `prompt_builder.py` (`build_response_prompt`):**
        *   Update the signature of the `build_response_prompt` function to accept the `current_difficulty` string.
        *   Add conditional logic within the prompt construction to include specific instructions for the AI based on the `current_difficulty` ('easy', 'Normal', 'hard'). These instructions will guide the AI on how to narrate the outcome of unreasonable or impossible player actions, following the logic defined in the "Impact" section above.
    *   **Ensure Plot Point Logic is Unaffected:** Verify that `ai_service.check_atomic_plot_completion` and `prompt_builder.build_plot_completion_check_prompt` are *not* modified to use the `current_difficulty` parameter, preserving the current plot completion logic.

6.  **Testing:**
    *   Manually test creating games and verifying the initial `current_difficulty` is set correctly.
    *   Test changing the difficulty via the UI on `play.html`. Verify the change is reflected in the UI for all players and persisted in the database.
    *   Test player actions, particularly those that might be considered unreasonable or impossible, at each difficulty level ('easy', 'Normal', 'hard') to verify the AI narrative response aligns with the specified logic.
    *   Test that changing difficulty does not alter the criteria or process for plot point completion.

## Files to Modify/Create
*   `questforge/models/game.py` (Modify)
*   Database migration script (New)
*   `questforge/templates/game/play.html` (Modify)
*   `questforge/static/js/socketClient.mjs` (Modify)
*   `questforge/services/socket_service.py` (Modify)
*   `questforge/services/ai_service.py` (Modify)
*   `questforge/utils/prompt_builder.py` (Modify)

## Considerations
*   Ensure smooth visual feedback in the UI when difficulty is changed.
*   Consider adding a system message to the game log when difficulty is changed.
*   Careful prompt engineering will be needed in `build_response_prompt` to ensure the AI consistently follows the difficulty instructions for unreasonable actions without negatively impacting its general narrative quality or state updates.
