{% extends "base.html" %}
{% from "partials/_messages.html" import flash_messages %}

{% block content %}
<div class="container-fluid game-container">
    <div class="row">
        <!-- Game State Visualization -->
        <div class="col-md-8">
            <div class="game-state-container">
                <div class="game-state-header">
                    {# Use the actual game name passed from the route #}
                    <div class="d-flex justify-content-between align-items-center"> {# Flex container for title and badges #}
                        <h3 id="gameTitle" data-game-id="{{ game.id }}" data-user-id="{{ user_id }}">{{ game.name | e }}</h3> 
                        <div class="game-status ms-3"> {# Margin start for spacing #}
                            <span class="badge bg-primary me-1">{{ game.status | e }}</span>
                            {# Cost display removed from here #}
                        </div>
                    </div>
                </div>
                {# Main area will now be the scrollable log #}
                <div id="mainGameLog" class="game-log-main mt-3"> 
                    <!-- Dynamic game log will be rendered here by JS -->
                    <p class="text-muted p-3">Loading game log...</p> 
                </div>
            </div>
        </div>

        <!-- Player Controls & Info -->
        <div class="col-md-4">
            <div class="player-controls">
                {# --- Always Visible Controls --- #}
                <div class="card">
                    <div class="card-header">
                        <h5>Available Actions</h5>
                    </div>
                    <div class="card-body" id="actionControls">
                        <!-- Dynamic action buttons will be inserted here -->
                    </div>
                </div>

                {# Add Custom Action Input - Kept outside tabs for easy access #}
                <div class="card mt-3 mb-3"> {# Added mb-3 for spacing before tabs #}
                    <div class="card-header">
                        <h5>Custom Action</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <input type="text" id="customActionInput" class="form-control" placeholder="Enter your action...">
                            <button class="btn btn-outline-secondary" type="button" id="submitCustomAction">Submit</button>
                        </div>
                    </div>
                </div>

                {# --- Tabbed Information Area --- #}
                <ul class="nav nav-tabs" id="infoTab" role="tablist">
                    {# Log tab removed #}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="state-tab" data-bs-toggle="tab" data-bs-target="#state-tab-pane" type="button" role="tab" aria-controls="state-tab-pane" aria-selected="true">State</button> 
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="info-tab-button" data-bs-toggle="tab" data-bs-target="#info-tab-pane" type="button" role="tab" aria-controls="info-tab-pane" aria-selected="false">Info</button>
                    </li>
                </ul>
                <div class="tab-content" id="infoTabContent">
                    {# Log Tab Pane Removed #}

                    {# State Tab Pane (Now active by default) #}
                    <div class="tab-pane fade show active" id="state-tab-pane" role="tabpanel" aria-labelledby="state-tab" tabindex="0">
                        <div class="card rounded-0 rounded-bottom"> {# Remove top rounding, keep bottom #}
                            <div class="card-body">
                                {# Inventory #}
                                <h6 class="card-subtitle mb-2 text-muted">Inventory</h6>
                                <div id="inventoryDisplay" class="mb-3"> {# Add margin bottom #}
                                    {% if game_state and game_state.state_data and 'inventory' in game_state.state_data %}
                                        {% if game_state.state_data.inventory %}
                                            <ul class="list-unstyled mb-0">
                                                {% for item in game_state.state_data.inventory %}
                                                    <li>{{ item | e }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Inventory is empty.</p>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted mb-0">Inventory data not available.</p>
                                    {% endif %}
                                </div>
                                <hr> {# Separator #}
                                {# Player Locations #}
                                <h6 class="card-subtitle my-2 text-muted">Player Locations</h6>
                                <div id="playerLocationsDisplay" class="mb-3"> {# Add margin bottom #}
                                    <p class="text-muted mb-0">Loading player locations...</p>
                                </div>
                                <hr> {# Separator #}
                                {# Visited Locations #}
                                <h6 class="card-subtitle my-2 text-muted">Visited Locations</h6>
                                <div id="locationHistoryDisplay">
                                    {% if game_state and game_state.visited_locations %}
                                        <ul class="list-unstyled mb-0">
                                            {% for location in game_state.visited_locations %}
                                                <li>{{ location | e }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted mb-0">No locations visited yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Info Tab Pane #}
                    <div class="tab-pane fade" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab-button" tabindex="0">
                        <div class="card rounded-0 rounded-bottom"> {# Remove top rounding, keep bottom #}
                            <div class="card-body">
                                {# Game Objective #}
                                <h6 class="card-subtitle mb-2 text-muted">Objective</h6>
                                <div id="gameObjective" class="mb-3"> {# Add margin bottom #}
                                    {% if campaign and campaign.objectives %}
                                        <pre>{{ campaign.objectives | tojson(indent=2) }}</pre>
                                    {% else %}
                                        <p class="text-muted mb-0">Objective not available.</p>
                                    {% endif %}
                                </div>
                                <hr> {# Separator #}
                                {# AI Model Info #}
                                <h6 class="card-subtitle my-2 text-muted">AI Model</h6>
                                <div id="aiModelInfo" class="mb-3"> {# Add margin bottom #}
                                    <p class="mb-0">Using model: <strong>{{ ai_model | e }}</strong></p>
                                </div>
                                <hr> {# Separator #}
                                {# Cost Display Moved Here #}
                                <h6 class="card-subtitle my-2 text-muted">Total Cost</h6>
                                <div id="totalCostDisplayWrapper">
                                    <span class="badge bg-info" id="totalCostDisplay">
                                        {% if total_cost > 0 %}
                                            Cost: ${{ "%.4f"|format(total_cost) }}
                                        {% else %}
                                            Cost: $0.0000 {# Display zero cost initially #}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> {# End Tab Content #}

            </div> {# End player-controls #}
        </div> {# End col-md-4 #}
    </div> {# End row #}
</div> {# End container-fluid #}

<style>
.game-container {
    padding: 20px;
    height: 100vh;
}
/* Style for the main log area */
.game-log-main {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    /* Adjust height as needed, maybe use viewport height minus header/footer */
    height: calc(100vh - 150px); /* Example height calculation */
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 15px; /* Add padding inside */
    /* display: flex; */ /* Flexbox removed */
    /* flex-direction: column-reverse; */ /* Removed */
}
.player-controls {
    position: sticky;
    top: 20px;
}
.game-log {
    /* Remove max-height from tabbed log style */
    /* overflow-y: auto; */ /* Removed */
}
.log-entry { /* General style for log entries */
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    background-color: #ffffff; /* White background for entries */
    border: 1px solid #e9ecef;
}
.log-entry-player {
    color: black;
    /* Optional: Add specific background or border */
    /* border-left: 3px solid #6c757d; */
}
.log-entry-ai {
    color: #0d6efd; /* Bootstrap primary blue */
    /* Optional: Add specific background or border */
    /* border-left: 3px solid #0d6efd; */
}
</style>

{% endblock %}

{% block scripts %}
<script type="module">
import socketClient from '/static/js/socketClient.mjs'; // Import the module

// Set current user ID globally for socketClient
window.currentUserId = '{{ user_id }}'; 

// Use the imported socketClient instance
// const socket = io(); // REMOVE THIS LINE

// --- Game State Update Handlers ---
// Listeners will be added inside the onReady callback

function updateGameState(state) {
    console.log("Updating game state display with:", state); 
    
    // Update Action Controls
    if (state && state.actions) {
        updateActionControls(state.actions);
    } else {
        updateActionControls([]); // Clear actions if none provided
    }

    // Update Game Log History Panel
    if (state && state.log) {
        updateGameLog(state.log); // Update the history panel
    } else {
        updateGameLog([]); // Clear log if none provided
    }

    // Main Game State Visualization (narrative) is now handled by updateGameLog targeting #mainGameLog
    // Old logic for #gameStateVisualization removed.

    // Update Player Locations Display
    if (state && state.player_locations) {
        updatePlayerLocationsDisplay(state.player_locations);
    } else {
        updatePlayerLocationsDisplay({}); // Clear if no data
    }

    // Update Visited Locations Display
    if (state && state.visited_locations) {
        updateVisitedLocationsDisplay(state.visited_locations);
    } else {
        updateVisitedLocationsDisplay([]); // Clear if no data
    }

    // Update Inventory Display (using state.state.current_inventory or state.state.inventory)
    const inventory = state?.state?.current_inventory ?? state?.state?.inventory; // Check both keys
    if (inventory !== undefined) { // Check if key exists (even if empty list)
        updateInventoryDisplay(inventory);
    } else {
        updateInventoryDisplay(null); // Indicate data not available
    }

    // Update total cost display if present in the update
    if (state && typeof state.total_cost !== 'undefined') {
        updateTotalCostDisplay(state.total_cost);
    }
}

// --- UI Update Functions ---

// Updated function to target the main log area and display latest first
function updateGameLog(log) {
    console.log('updateGameLog received:', log); // Add log to check received data
    const mainGameLog = document.getElementById('mainGameLog'); // Target the new main log container
    if (!mainGameLog) {
        console.error("mainGameLog element not found");
        return;
    }
    // Clear previous logs by removing child nodes
    while (mainGameLog.firstChild) {
        mainGameLog.removeChild(mainGameLog.firstChild);
    }
    // Iterate through the log and append new entries
    log.forEach(item => {
        const logEntry = document.createElement('div');
        logEntry.classList.add('log-entry');
        let content = '';
        if (typeof item === 'object' && item !== null && item.content) {
            content = item.content; // Extract content if it's an object
            if (item.type === "player") {
                logEntry.classList.add('log-entry-player');
            } else if (item.type === "ai") {
                logEntry.classList.add('log-entry-ai');
            }
        } else {
            content = item; // Use item directly if it's a string
        }
        // Sanitize content before setting innerHTML or use innerText
        // Using innerText is safer against XSS if HTML rendering isn't needed
        logEntry.innerText = content;

        // Append the new entry to the bottom
        mainGameLog.appendChild(logEntry);
    });
    // Scroll to the bottom after adding all entries
    // Wrap in setTimeout to ensure DOM update completes before scrolling
    setTimeout(() => {
        mainGameLog.scrollTop = mainGameLog.scrollHeight;
    }, 0);
}


// Function to update the total cost display (no changes needed, targets correct ID)
function updateTotalCostDisplay(cost) {
    const costElement = document.getElementById('totalCostDisplay'); // Need to add this ID to the HTML element
    if (costElement) {
        // Format cost to 4 decimal places
        costElement.textContent = `Cost: $${cost.toFixed(4)}`;
    } else {
        console.warn("totalCostDisplay element not found.");
    }
}

// New function to update Player Locations display
function updatePlayerLocationsDisplay(playerLocations) {
    const displayElement = document.getElementById('playerLocationsDisplay');
    if (!displayElement) {
        console.error("playerLocationsDisplay element not found");
        return;
    }
    let html = '<ul class="list-unstyled mb-0">';
    if (playerLocations && Object.keys(playerLocations).length > 0) {
        // Assuming playerLocations is an object like { 'user_id': 'location_name', ... }
        // You might need to fetch usernames if you want to display them instead of IDs
        for (const [userId, location] of Object.entries(playerLocations)) {
            // TODO: Fetch username based on userId if needed for better display
            html += `<li>Player ${userId}: ${location || 'Unknown'}</li>`; 
        }
    } else {
        html += '<li class="text-muted">No player location data available.</li>';
    }
    html += '</ul>';
    displayElement.innerHTML = html;
}

// New function to update Visited Locations display
function updateVisitedLocationsDisplay(visitedLocations) {
    const displayElement = document.getElementById('locationHistoryDisplay');
    if (!displayElement) {
        console.error("locationHistoryDisplay element not found");
        return;
    }
    let html = '<ul class="list-unstyled mb-0">';
    if (visitedLocations && visitedLocations.length > 0) {
        visitedLocations.forEach(location => {
            html += `<li>${location}</li>`; // Assuming location is a string
        });
    } else {
        html += '<li class="text-muted">No locations visited yet.</li>';
    }
    html += '</ul>';
    displayElement.innerHTML = html;
}

// New function to update Inventory display
function updateInventoryDisplay(inventory) {
    const displayElement = document.getElementById('inventoryDisplay');
    if (!displayElement) {
        console.error("inventoryDisplay element not found");
        return;
    }
    let html = '<ul class="list-unstyled mb-0">';
    if (inventory === null) {
         html += '<li class="text-muted">Inventory data not available.</li>';
    } else if (inventory && inventory.length > 0) {
        inventory.forEach(item => {
            html += `<li>${item}</li>`; // Assuming item is a string
        });
    } else {
        html += '<li class="text-muted">Inventory is empty.</li>';
    }
    html += '</ul>';
    displayElement.innerHTML = html;
}


function updateActionControls(actions) {
    const actionControls = document.getElementById('actionControls');
     if (!actionControls) {
        console.error("actionControls element not found");
        return;
    }
    actionControls.innerHTML = ''; // Clear previous actions
    if (actions && Array.isArray(actions)) {
        actions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'btn btn-primary mb-2 w-100'; // Make buttons full width
            // TODO: Use a more descriptive property than 'name' if available
            button.innerText = typeof action === 'object' ? action.name || JSON.stringify(action) : action; 
            button.onclick = () => performAction(action);
            actionControls.appendChild(button);
        });
    } else {
        console.warn("No valid actions received to update controls.");
        actionControls.innerHTML = '<p class="text-muted">No actions available.</p>';
    }
}

// --- Action Emission ---

function performAction(action) {
    console.log("Performing action:", action); // Add log
    // Emit action to server
    const gameTitleElement = document.getElementById('gameTitle');
    if (!gameTitleElement) {
         console.error("gameTitle element not found, cannot perform action.");
         return;
    }
    const game_id = gameTitleElement.dataset.gameId;
    const user_id = gameTitleElement.dataset.userId;
    
    // TODO: Structure the action payload correctly based on server expectations
    // Assuming the server expects the 'action' object directly for now
    if (socketClient && socketClient.socket) {
        socketClient.socket.emit('player_action', {
            game_id: game_id,
            user_id: user_id,
            action: action // Send the action object/string received
        });
    } else {
         console.error("socketClient or socketClient.socket not available! Cannot emit player_action.");
    }
}

// --- State Rendering ---

// renderCurrentScene function removed as it's no longer used.
// Narrative is now part of the main log handled by updateGameLog.

// --- Initial Setup ---
const gameId = document.getElementById('gameTitle')?.dataset.gameId; // Get gameId early

if (gameId) {
    let initialStateRequested = false;

    // Define the function to request initial state
    const requestInitialState = () => {
        // Check socketClient.socket directly
        const userId = document.getElementById('gameTitle')?.dataset.userId; // Get user_id
        if (!initialStateRequested && socketClient.socket && socketClient.connected && userId) {
            console.log(`Requesting initial state for game ${gameId} by user ${userId}`);
            socketClient.socket.emit('request_state', { game_id: gameId, user_id: userId }); // Add user_id
            initialStateRequested = true;
        } else if (!initialStateRequested) {
             console.log("Socket not ready/available when requestInitialState was called.");
        }
    };

    // Setup listeners after connection
    const setupListenersAndRequestState = () => {
        console.log("Play page: Socket connected. Setting up listeners and requesting initial state.");

        if (!socketClient.socket) {
             console.error("Play page: setupListenersAndRequestState called but socketClient.socket is not available! Aborting setup.");
             return;
        }
        
        // Join the room for this game (using the object's method)
        socketClient.joinRoom(gameId); 

        // --- Setup Listeners ---
        console.log("Play page: Setting up socket listeners.");
        socketClient.socket.off('game_state_update'); // Clear potential old listeners
        socketClient.socket.off('game_state');

        socketClient.socket.on('game_state_update', (data) => {
            console.log("Play page: Received game_state_update:", data);

            // --- Debugging Log Update ---
            const logData = data?.log;
            const logLength = Array.isArray(logData) ? logData.length : 'Not an array';
            const lastLogEntry = Array.isArray(logData) && logData.length > 0 ? JSON.stringify(logData[logData.length - 1]) : 'N/A';
            console.log(`DEBUG: game_state_update received log length: ${logLength}`);
            console.log(`DEBUG: game_state_update last log entry: ${lastLogEntry}`);
            // You can also add a temporary visual indicator like before if needed:
            // try {
            //     const testEntry = document.createElement('p');
            //     testEntry.innerText = `DEBUG: Update v${data?.version || '?'}. Log Len: ${logLength}. Last: ${lastLogEntry.substring(0, 50)}`;
            //     testEntry.style.color = 'orange'; testEntry.style.fontSize = '0.8em';
            //     document.getElementById('mainGameLog')?.appendChild(testEntry);
            // } catch (e) { console.error("Error adding debug entry:", e); }
            // --- End Debugging ---

            updateGameState(data); // Call the original update function
        });

        socketClient.socket.on('game_state', (state) => {
            console.log("Play page: Received full game state:", state);
            updateGameState(state);
        });

        // --- Request Initial State ---
        requestInitialState(); // Call the request function now that listeners are set up
    };

    // Register the setup function to run when the socket connects
    // Use the onConnectCallbacks array from the socketClient object
    socketClient.onConnectCallbacks.push(setupListenersAndRequestState);

    // Initiate the connection process for this game ID.
    console.log("Calling socketClient.connect(gameId) for play page.");
    socketClient.connect(gameId); // This will eventually trigger the callbacks in onConnectCallbacks

} else {
    console.error("Game ID not found in DOM, cannot initialize socket connection.");
}

// --- Custom Action Input Handler ---
const customActionInput = document.getElementById('customActionInput');
const submitCustomActionButton = document.getElementById('submitCustomAction');

if (customActionInput && submitCustomActionButton) {
    // Handle button click
    submitCustomActionButton.addEventListener('click', () => {
        const actionText = customActionInput.value.trim();
        if (actionText) {
            performAction(actionText); // Use the existing function to send the action
            customActionInput.value = ''; // Clear the input field
        }
    });

    // Handle Enter key press in the input field
    customActionInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default form submission if it were in a form
            submitCustomActionButton.click(); // Trigger the button click handler
        }
    });
} else {
    console.error("Custom action input elements not found.");
}

</script>
{% endblock %}
